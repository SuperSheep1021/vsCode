"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_1=require("vscode"),Utilities_1=require("./Utilities"),Shaderlab_1=require("./Shaderlab");var CodeSegmentType;!function(e){e[e.Code=0]="Code",e[e.String=1]="String",e[e.Comment=2]="Comment"}(CodeSegmentType||(CodeSegmentType={}));class CodeSegments{constructor(e,t){this.code=e,this.type=t}}class Formatter{constructor(e){this.tabs=e}formatDocument(e){let t=this.getCodeSegments(e.getText()),r="";return(t=t.map((e,t)=>this.formatCodeSegments(e))).forEach(e=>{r+=e.code}),r=this.formatProperties(r),r=this.formatCodeTextWithLevels(r),new vscode_1.TextEdit(Utilities_1.default.GetFullRangeOfDocument(e),this.formatTags(r))}formatCodeTextWithLevels(e){let t=e.split(/\n/gi),r=0,s=!1;for(let e=0;e<t.length;e++){let i=t[e];if(r<0&&(r=0),i)if(i.endsWith("\\")||e-1>=0&&t[e-1].trim().endsWith("\\")||(i=i.trim()),t[e]=this.getTabByLevel(r)+i,i.startsWith("#if")||i.endsWith("{")&&!i.startsWith("#"))r+=1;else if(!i.endsWith("(")||i.startsWith("#")){if(s)i.startsWith(")")?(t[e]=this.getTabByLevel(r-1)+i,r-=1,s=!1):i.endsWith(")")&&(r-=1,s=!1);else if(i.startsWith("#endif")||i.startsWith("}")&&!i.startsWith("#"))t[e]=this.getTabByLevel(r-1)+i,r-=1;else if(i.startsWith("#else")||i.startsWith("#elif"))t[e]=this.getTabByLevel(r-1)+i;else if(e>0){let s=t[e-1].trim(),a=(s.endsWith(")")||s.startsWith("else"))&&(s.startsWith("if")||e-2>=0&&(-1!=t[e-2].trim().indexOf("&&")||-1!=t[e-2].trim().indexOf("||")))||(-1!=s.indexOf("&&")||-1!=s.indexOf("||"))&&!this.isProperties(i)&&!s.startsWith("#")&&!s.startsWith("//");if(a){t[e]=this.getTabByLevel(r+1)+i;continue}}}else r+=1,s=!0}return t.join("\r\n")}isProperties(e){return Shaderlab_1.default.getPropertiesDefinationRegPattern().test(e)}removeComments(e){let t="";return this.getCodeSegments(e).forEach(e=>{e.type!==CodeSegmentType.Comment&&(t+=e.code)}),t}formatCodeSegments(e){let t=e.code;if(e.type===CodeSegmentType.Comment)return e;if(e.type===CodeSegmentType.String)return e;for(let e=0;e<10;e++)t=(t=t.replace(/(#define)[ \t]+([\w\d_\(\) \t]+)\{/gi,"$1 $2____shaderlabvscode__zdakuohao__amlovey__")).replace(/(#define)[ \t]+([\w\d_\(\) \t]+)\}/gi,"$1 $2____shaderlabvscode__ydakuohao__amlovey__");return t=this.formatSymbols(t),t=this.formatProgramClourse(t),t=this.formatControlFlow(t),t=(t=(t=this.formatMacros(t)).replace(/____shaderlabvscode__zdakuohao__amlovey__/gi,"{")).replace(/____shaderlabvscode__ydakuohao__amlovey__/gi,"}"),new CodeSegments(t,e.type)}formatControlFlow(e){let t=e.replace(/\)[ \t]*{[ \t]*}/gim,") \r\n{ \r\n\r\n}");return t=t.replace(/else[ \t]*{[ \t]*}/gim,"else\r\n{ \r\n\r\n}"),t=t.replace(/\}[ \t]*else/gim,"}\r\nelse"),t=t.replace(/do[ \t]*{[ \t]*}/gim,"do\r\n{ \r\n\r\n}"),t=t.replace(/if[ \t]*\(/,"if ("),t=t.replace(/for\s*\(([\s\S]*?)\s*;\s*([\s\S]*?)\s*;\s*([\s\S]*?)\s*?\)/gim,"for ($1; $2; $3)")}formatProgramClourse(e){return e.replace(/\n?[ \t]*?(CGPROGRAM|ENDCG|GLSLPROGRAM|ENDGLSL|HLSLPROGRAM|ENDHLSL)[\s\r\n]+/gim,"\r\n$1\r\n\r\n")}formatTags(e){let t=e.replace(/\s*"(RenderType|Queue|DisableBatching|ForceNoShadowCasting|IgnoreProjector|CanUseSpriteAtlas|PreviewType|LightMode|PassFlags|RequireOptions)"/gim,` "$1"`);return t=t.replace(/(Tags|tags)\s*?{\s*([ \S]*?)\s*}\n?/gim,"$1 { $2 }")}formatSymbols(e){let t=e.replace(/\s*{[ \t]*\r?\n?/gim,"\r\n{\r\n");return t=t.replace(/\s*}[ \t]?/gim,"\r\n}"),t=t.replace(/\s*{\s*}/gim," { }"),t=this.formatSemicolon(t),t=this.formatLineSymbols(t)}formatSemicolon(e){let t=e.replace(/}\s*;\r?\n?/gim,"};\r\n");return t=t.replace(/;\s*\\/gim,"; \\")}formatMacros(e){return e.replace(/#[ \t]+?(if|elif|else|endif)+/gi,"#$1")}formatLineSymbols(e){let t=e.replace(/(#define)[ \t]+([\w\d_]+)[ \t]/gim,"$1 $2______shaderlabvscode________amlovey__________");t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/[ \t]*\([ \t]*/gim,"(")).replace(/______shaderlabvscode________amlovey__________/gim," ")).replace(/\s*=\s*/gim," = ")).replace(/[ \t]*-[ \t]*/gim," - ")).replace(/[ \t]*:[ \t]*/gim,": ")).replace(/[ \t]*\+[ \t]*/gim," + ")).replace(/[ \t]*>[ \t]*/gim," > ")).replace(/[ \t]*<[ \t]*/gim," < ")).replace(/[ \t]*\*[ \t]*/gim," * ")).replace(/[ \t]*\/[ \t]*/gim," / ")).replace(/[ \t]*%[ \t]*/gim," % ")).replace(/[ \t]*&[ \t]*/gim," & ")).replace(/[ \t]*\|[ \t]*/gim," | ")).replace(/[ \t]*\)/gim,")")).replace(/[ \t]*\/[ \t]*\/[ \t]*/gim," // ")).replace(/\)\(/gim,") (")).replace(/[ \t]*>[ \t]*>[ \t]*/gim," >> ")).replace(/[ \t]*<[ \t]*<[ \t]*/gim," << ")).replace(/[ \t]*-[ \t]*-[ \t]*/gim," -- ")).replace(/[ \t]*\+[ \t]*\+[ \t]*/gim," ++ ")).replace(/[ \t]*-[ \t]*=[ \t]*/gim," -= ")).replace(/[ \t]*\*[ \t]*=[ \t]*/gim," *= ")).replace(/[ \t]*=[ \t]*=[ \t]*/gim," == ")).replace(/[ \t]*&[ \t]*&[ \t]*/gim," && ")).replace(/[ \t]*\|[ \t]*\|[ \t]*/gim," || ")).replace(/[ \t]*\+[ \t]*=[ \t]*/gim," += ")).replace(/[ \t]*<[ \t]*=[ \t]*/gim," <= ")).replace(/[ \t]*>[ \t]*=[ \t]*/gim," >= ")).replace(/[ \t]*\/[ \t]*=[ \t]*/gim," /= ")).replace(/[ \t]*![ \t]*=[ \t]*/gim," != ")).replace(/[ \t]*&[ \t]*=[ \t]*/gim," &= ")).replace(/[ \t]*\|[ \t]*=[ \t]*/gim," |= ")).replace(/[ \t]*\^[ \t]*=[ \t]*/gim," ^= ")).replace(/[ \t]*%[ \t]*=[ \t]*/gim," %= ")).replace(/[ \t]*<[ \t]*<[ \t]*=[ \t]*/gim," <<= ")).replace(/[ \t]*>[ \t]*>[ \t]*=[ \t]*/gim," >>= ")).replace(/[ \t]*\+[ \t]*\+[ \t]*=[ \t]*=[ \t]*/gim,"++ == ")).replace(/[ \t]*-[ \t]*-[ \t]*=[ \t]*=[ \t]*/gim,"-- == ")).replace(/\s*?,[ \t]*/gim,", ")).replace(/(\d+)e[ \t]*-[ \t]*(\d+)/gim,"$1e-$2")).replace(/(=)[ \t]*(-|\+)[ \t]*(\w+)/gim,"$1 $2$3")).replace(/(,)[ \t]*(-|\+)[ \t]*(\w+)/gim,"$1 $2$3")).replace(/(\()[ \t]*(-|\+)[ \t]*(\w+)/gim,"$1$2$3")).replace(/(offset)[ \t]*(-|\+)[ \t]*(\w+)/gim,"$1 $2$3")).replace(/(\S*?)\s*<\s*(\S*)\s*>\s*(\S*)\s*?(;)/gim,"$1<$2> $3$4")).replace(/(\S*?)\s*<\s*(\S*)\s*>\s*(\S*)\s*?(=)/gim,"$1<$2> $3 $4");for(let e=0;e<10;e++)t=t.replace(/(#[\w: \t]+?):[ \t]+/gim,"$1:");return t}formatProperties(e){return e.replace(/([\S]*?)\s*?\("([\s\S]*?)"\s*,\s*([\s\S]+?)\)\s*=/gim,'$1 ("$2", $3) =')}getCodeSegments(e){let t=!1,r=!1,s=-1,i=0,a=-1,l=[];for(let o=0;o<e.length;o++){let m=e.charAt(o);if("/"===m&&-1===s){if(o+1<=e.length){let r=e.charAt(o+1);"/"===r?(s=o,t=!1):"*"===r&&(s=o,t=!0),o++}}else if("\n"===m&&s>-1&&!t){let t=e.substring(i,s),r=e.substring(s,o),a=new CodeSegments(t,CodeSegmentType.Code),m=new CodeSegments(r,CodeSegmentType.Comment);l.push(a),l.push(m),s=-1,i=o}else if("*"===m&&t){if(o+1<=e.length){let r=e.charAt(o+1);if("/"===r){let r=e.substring(i,s),a=e.substring(s,o+2),m=new CodeSegments(r,CodeSegmentType.Code),n=new CodeSegments(a,CodeSegmentType.Comment);l.push(m),l.push(n),s=-1,i=o+2,t=!1,o++}}}else if('"'!==m||r||-1!=s){if('"'===m&&r&&-1==s){let t=e.substring(i,a),s=e.substring(a,o+1),m=new CodeSegments(t,CodeSegmentType.Code),n=new CodeSegments(s,CodeSegmentType.String);l.push(m),l.push(n),a=-1,r=!1,i=o+1}}else r=!0,a=o}if(i<e.length){let t=e.substring(i,e.length);l.push(new CodeSegments(t,CodeSegmentType.Code))}return l}getTabByLevel(e){return e<0&&(e=0),this.getRepeatText(this.tabs,e)}getRepeatText(e,t){let r="";if(!e||t<0)return r;for(let s=0;s<t;s++)r+=e;return r}}exports.default=Formatter;